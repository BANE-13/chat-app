<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>chatting with . . .</title>

<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">

<style>
body {
  font-family: 'SUIT', sans-serif;
  background: #ececec;
}

#enterScreen {
  max-width: 320px;
  margin: 80px auto;
  padding: 24px;
  background: white;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

#chatBox {
  max-width: 400px;
  margin: 20px auto;
  display: none;
}

#chat {
  background: #ecdff5;
  padding: 10px;
  height: 400px;
  overflow-y: auto;
  border-radius: 10px;
}

.bubble {
  max-width: 75%;
  padding: 10px 15px;
  margin: 10px 0;
  font-size: 14px;
  clear: both;
  line-height: 1.4;
  position: relative;
  box-shadow: o 2px 5px rgba(0, 0, 0, 0.05);
}

.me {
  background: #664b7d;
  color: white;
  float: right;
  border-radius: 18px 2px 18px 18px;
  text-align: right;
}

.other {
  background: white;
  float: left;
  border-radius: 2px 18px 18px 18px;
  color: #333;
}

.name {
  font-size: 12px;
  font-weight: bold;
  color: #555;
  margin-bottom: 4px;
  margin-left: 2px;
}

.time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 5px;
  text-align: right;
}

input {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  border-radius: 20px;
  border: none;
  outline: none;
}

button {
  width: 100%;
  padding: 10px;
  border-radius: 20px;
  border: none;
  background: #664b7d;
  color: white;
  cursor: pointer;
}

#inputArea {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

#inputArea input {
  flex: 1;
  width: auto;
}

#inputArea button {
  width: auto;
  padding: 10px;
  flex-shrink: 0;
}

</style>
</head>

<body>

<!-- ì…ì¥ í™”ë©´ -->
<div id="enterScreen">
  <h3>ì±„íŒ… ì…ì¥</h3>
  <input id="nickname" placeholder="ë‹‰ë„¤ì„">
  <input id="roomInput" placeholder="ë°© ì´ë¦„">
  <button onclick="enterRoom()">ì…ì¥í•˜ê¸°</button>
</div>

<!-- ì±„íŒ… í™”ë©´ -->
<div id="chatBox">
  <h3 id="roomTitle"></h3>
  <div id="chat"></div>

  <div id="inputArea">
    <input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button onclick="send()">ì „ì†¡</button>
  </div>
</div>

<script type="module">

/* 1ï¸âƒ£ URLì—ì„œ roomê³¼ nickname ì •ë³´ ê°€ì ¸ì˜¤ê¸° */
const params = new URLSearchParams(location.search);
const room = params.get("room");
const savedNickname = params.get("nickname"); // ì¶”ê°€ëœ ë¶€ë¶„

/* 2ï¸âƒ£ DOM ìš”ì†Œ ì„ ì–¸ */
const enterScreen = document.getElementById("enterScreen");
const chatBox = document.getElementById("chatBox");
const roomTitle = document.getElementById("roomTitle");
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");

let nickname = savedNickname || ""; // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹‰ë„¤ì„ ì„¤ì •

/* 3ï¸âƒ£ ì…ì¥ ë²„íŠ¼ í•¨ìˆ˜ (ì „ì—­ ë“±ë¡) */
window.enterRoom = () => {
  const nickInput = document.getElementById("nickname").value.trim();
  const roomInput = document.getElementById("roomInput").value.trim();

  if (!nickInput || !roomInput) {
    alert("ë‹‰ë„¤ì„ê³¼ ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  // ë‹‰ë„¤ì„ê³¼ ë°© ì´ë¦„ì„ ëª¨ë‘ URLì— ë‹´ì•„ì„œ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë¶€ë¦…ë‹ˆë‹¤.
  location.href = `?room=${encodeURIComponent(roomInput)}&nickname=${encodeURIComponent(nickInput)}`;
};

/* 4ï¸âƒ£ roomê³¼ nicknameì´ ëª¨ë‘ ìˆì„ ë•Œë§Œ ì±„íŒ… ì‹œì‘ */
if (room && nickname) {
  enterScreen.style.display = "none";
  chatBox.style.display = "block";
  roomTitle.textContent = `ğŸ’¬ ${room}`;

  import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(({ initializeApp }) => {
    import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(({ getDatabase, ref, push, onChildAdded }) => {

      const app = initializeApp({
        apiKey: "AIzaSyBeMC5TQ7Jynxjpr_kjhijGUvZyly2D_gs",
        databaseURL: "https://my-chat-app-241e8-default-rtdb.firebaseio.com"
      });

      const db = getDatabase(app);
      const chatRef = ref(db, `chat/${room}`);

      // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
      window.send = () => {
        const text = msg.value.trim();
        if (!text) return;
        
        push(chatRef, {
          name: nickname,
          text: text,
          time: Date.now()
        });
        msg.value = "";
      };

      // ì—”í„°í‚¤ ì²˜ë¦¬
      msg.addEventListener("keydown", e => {
        if (e.key === "Enter") send();
      });

      // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹  ë° í™”ë©´ í‘œì‹œ
      onChildAdded(chatRef, snap => {
        const d = snap.val();
        const b = document.createElement("div");
        b.className = "bubble " + (d.name === nickname ? "me" : "other");

        // ìƒëŒ€ë°© ì´ë¦„ í‘œì‹œ
        if (d.name !== nickname) {
          const n = document.createElement("div");
          n.className = "name";
          n.textContent = d.name;
          chat.appendChild(n);
        }

        // ë©”ì‹œì§€ ë‚´ìš© (XSS ë°©ì§€ë¥¼ ìœ„í•´ textContent ì‚¬ìš©)
        const t = document.createElement("div");
        t.textContent = d.text;
        b.appendChild(t);

        // ì‹œê°„ í‘œì‹œ
        const tm = document.createElement("div");
        tm.className = "time";
        tm.textContent = new Date(d.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        b.appendChild(tm);

        chat.appendChild(b);
        chat.scrollTop = chat.scrollHeight; // ìŠ¤í¬ë¡¤ í•˜ë‹¨ ì´ë™
      });

    });
  });
} else if (room && !nickname) {
  // ë°© ì´ë¦„ì€ ìˆëŠ”ë° ë‹‰ë„¤ì„ì´ ì—†ëŠ” ê²½ìš° ë‹¤ì‹œ ì…ë ¥ì°½ìœ¼ë¡œ ë³´ëƒ„
  alert("ë‹‰ë„¤ì„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
  location.href = window.location.pathname; 
}
</script>

</body>
</html>



