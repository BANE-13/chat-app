<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>chatting with . . .</title>

<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">

<style>
body { font-family: 'SUIT', sans-serif; background: #ececec; }

#enterScreen {
  max-width: 320px; margin: 80px auto; padding: 24px;
  background: white; border-radius: 16px; text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

#chatBox { max-width: 400px; margin: 20px auto; display: none; }

#chat {
  background: #ecdff5; padding: 10px; height: 400px;
  overflow-y: auto; border-radius: 10px; display: flex; flex-direction: column;
}

.bubble {
  max-width: 75%; padding: 10px 15px; font-size: 14px;
  line-height: 1.4; position: relative;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.me { background: #664b7d; color: white; border-radius: 18px 2px 18px 18px; align-self: flex-end; }
.other { background: white; color: #333; border-radius: 2px 18px 18px 18px; align-self: flex-start; }

.name { font-size: 16px; font-weight: bold; color: #444; margin-bottom: 2px; margin-left: 5px; margin-top: 15px; }
.time { font-size: 10px; opacity: 0.6; margin-top: 1px; }

/* ì‹œê°„ ì •ë ¬ */
.me + .time { text-align: right; width: 100%; }
.other + .time { text-align: left; width: 100%; }

/* ê³µì§€ì‚¬í•­ ìŠ¤íƒ€ì¼ */
#noticeArea {
  background: rgba(102, 75, 125, 0.9); color: white; padding: 10px;
  border-radius: 8px; margin-bottom: 10px; font-size: 13px;
  display: none; position: sticky; top: 0; z-index: 10;
}

/* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.del-btn {
  background: rgba(255, 0, 0, 0.7); /* ë¹¨ê°„ìƒ‰ ë°°ê²½ */
  color: white !important;         /* ê¸€ììƒ‰ ë¬´ì¡°ê±´ í°ìƒ‰ */
  border: none;
  font-size: 10px;
  cursor: pointer;
  padding: 2px 6px;
  margin-left: 8px;
  border-radius: 4px;
  vertical-align: middle;
  display: inline-block;
}
.del-btn:hover { background: red; }

/* í‘¸í„° ìŠ¤íƒ€ì¼ */
.footer { text-align: center; font-size: 11px; color: #999; margin-top: 15px; margin-bottom: 10px; letter-spacing: 0.5px; }

input { width: 100%; margin: 6px 0; padding: 10px; border-radius: 20px; border: none; outline: none; box-sizing: border-box; }
button { width: 100%; padding: 10px; border-radius: 20px; border: none; background: #664b7d; color: white; cursor: pointer; }

#inputArea { display: flex; gap: 8px; margin-top: 8px; }
#inputArea input { flex: 1; }
#inputArea button { width: auto; padding: 10px 15px; }
</style>
</head>

<body>

<div id="enterScreen">
  <h3>Hello! chatting with your friends!</h3>
  <input id="nickname" placeholder="Nickname">
  <input id="roomInput" placeholder="Chatting room name">
  <button onclick="enterRoom()">Let's go!</button>
</div>

<div id="chatBox">
  <h3 id="roomTitle"></h3>
  <div id="noticeArea">ğŸ“Œ ê³µì§€: <span id="noticeText"></span></div>
  <div id="chat"></div>
  <div id="inputArea">
    <input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button onclick="send()">ì „ì†¡</button>
  </div>
  <div class="footer">made by ìœ ìˆ˜ì±„ - ë¬¸ì˜ëŠ” instagram @weso.alive</div>
</div>

<script type="module">
const params = new URLSearchParams(location.search);
const room = params.get("room");
const savedNickname = params.get("nickname");

const enterScreen = document.getElementById("enterScreen");
const chatBox = document.getElementById("chatBox");
const roomTitle = document.getElementById("roomTitle");
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");

let nickname = savedNickname || "";

window.enterRoom = () => {
  const nickInput = document.getElementById("nickname").value.trim();
  const roomInput = document.getElementById("roomInput").value.trim();
  if (!nickInput || !roomInput) { alert("ë‹‰ë„¤ì„ê³¼ ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }
  location.href = `?room=${encodeURIComponent(roomInput)}&nickname=${encodeURIComponent(nickInput)}`;
};

if (room && nickname) {
  enterScreen.style.display = "none";
  chatBox.style.display = "block";
  roomTitle.textContent = `ğŸ’¬ ${room}`;

  import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(({ initializeApp }) => {
    import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(({ getDatabase, ref, push, onChildAdded, get, set, remove, onValue, onChildRemoved }) => {

      const firebaseConfig = {
        apiKey: "AIzaSyBeMC5TQ7Jynxjpr_kjhijGUvZyly2D_gs",
        databaseURL: "https://my-chat-app-241e8-default-rtdb.firebaseio.com"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const chatRef = ref(db, `chat/${room}/messages`);
      const infoRef = ref(db, `chat/${room}/info`);
      const noticeRef = ref(db, `chat/${room}/notice`);
      
      let isHost = false;

      // [ë°©ì¥ í™•ì¸ ë¡œì§]
get(infoRef).then((snapshot) => {
  if (!snapshot.exists()) {
    const hostPw = prompt("ì´ ë°©ì˜ ë°©ì¥ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”:");
    if (hostPw) {
      set(infoRef, { host: nickname, pw: hostPw });
      isHost = true; // ì—¬ê¸°ì„œ true ì„¤ì •
      roomTitle.innerHTML += ` <span style="font-size:12px; color:gold;">ğŸ‘‘ ë°©ì¥</span>`;
    }
  } else {
    const data = snapshot.val();
    if (data.host === nickname) {
      const inputPw = prompt("ë°©ì¥ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (inputPw === data.pw) {
        isHost = true; // ì—¬ê¸°ì„œ true ì„¤ì •
        roomTitle.innerHTML += ` <span style="font-size:12px; color:gold;">ğŸ‘‘ ë°©ì¥</span>`;
      } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¤ ì¼ë°˜ ìœ ì €ë¡œ ì…ì¥í•©ë‹ˆë‹¤.");
      }
    }
  }
}).catch(err => console.error("ë°©ì¥ í™•ì¸ ì—ëŸ¬:", err));

      // [ê³µì§€ ì‹¤ì‹œê°„ ê°ì‹œ]
      onValue(noticeRef, (snap) => {
        const text = snap.val();
        const noticeArea = document.getElementById("noticeArea");
        if (text) {
          noticeArea.style.display = "block";
          document.getElementById("noticeText").textContent = text;
        } else { noticeArea.style.display = "none"; }
      });

      window.send = () => {
        const text = msg.value.trim();
        if (!text) return;

        
if (text.startsWith("/ê³µì§€")) {
    if (isHost) {
      const noticeMsg = text.replace("/ê³µì§€", "").trim();
      set(noticeRef, noticeMsg);
      msg.value = "";
      alert("ê³µì§€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); // ë“±ë¡ í™•ì¸ìš© ì•Œë¦¼
      return;
    } else {
      alert("ê³µì§€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤ (ë°©ì¥ ì „ìš©).");
    }
  }

  push(chatRef, { name: nickname, text: text, time: Date.now() });
  msg.value = "";
};
      
      msg.addEventListener("keydown", e => { if (e.key === "Enter") send(); });

// [ë©”ì‹œì§€ ìˆ˜ì‹  - ì¤‘ë³µ ì œê±° ë° ë ˆì´ì•„ì›ƒ êµì • ë²„ì „]
onChildAdded(chatRef, snap => {
  const d = snap.val();
  const msgKey = snap.key;
  const isMe = d.name === nickname;

  const wrapper = document.createElement("div");
  wrapper.id = `wrapper-${msgKey}`;
  wrapper.style.marginBottom = "15px";
  wrapper.style.display = "flex";
  wrapper.style.flexDirection = "column";
  wrapper.style.alignItems = isMe ? "flex-end" : "flex-start";
  wrapper.style.width = "100%";

  if (!isMe) {
    const n = document.createElement("div");
    n.className = "name";
    get(infoRef).then(infoSnap => {
      n.textContent = (infoSnap.exists() && infoSnap.val().host === d.name) ? `ğŸ‘‘ ${d.name}` : d.name;
    });
    wrapper.appendChild(n);
  }

  // [ìˆ˜ì • í¬ì¸íŠ¸] ê°€ë¡œ ìƒìê°€ í•„ìš”í•œ ë§Œí¼ë§Œ ê°€ë¡œ ê¸¸ì´ë¥¼ ê°€ì§€ë„ë¡ ì„¤ì •
  const line = document.createElement("div");
  line.style.display = "flex";
  line.style.alignItems = "flex-end";
  line.style.gap = "8px";
  line.style.flexDirection = isMe ? "row-reverse" : "row";
  line.style.width = "max-content"; // í•µì‹¬: ë‚´ìš©ë¬¼ë§Œí¼ë§Œ ê°€ë¡œ ê¸¸ì´ ì°¨ì§€
  line.style.maxWidth = "85%";     // í™”ë©´ì˜ 85% ë„˜ì§€ ì•Šê²Œ

  const b = document.createElement("div");
  b.className = "bubble " + (isMe ? "me" : "other");
  b.textContent = d.text;
  
  // ë§í’ì„  ìŠ¤íƒ€ì¼ ë³´ê°• (ì„¸ë¡œ ë°©ì§€)
  b.style.display = "block";
  b.style.margin = "0";
  b.style.wordBreak = "break-word"; // ê¸´ ë¬¸ì¥ì€ ì¤„ë°”ê¿ˆ
  line.appendChild(b);

  // ì‚­ì œ ë²„íŠ¼ ë¡œì§
  get(infoRef).then(infoSnap => {
    if (infoSnap.exists() && infoSnap.val().host === nickname) {
      const delBtn = document.createElement("button");
      delBtn.innerHTML = "âœ•";
      delBtn.className = "del-btn";
      
      // ë²„íŠ¼ ëª¨ì–‘ ì™„ì „ ê³ ì •
      delBtn.style.flexShrink = "0"; 
      delBtn.style.width = "22px";   
      delBtn.style.height = "22px";  
      delBtn.style.padding = "0";
      delBtn.style.margin = "0";
      delBtn.style.display = "inline-flex";
      delBtn.style.alignItems = "center";
      delBtn.style.justifyContent = "center";
      
      delBtn.onclick = () => { if(confirm("ì‚­ì œí• ê¹Œìš”?")) remove(ref(db, `chat/${room}/messages/${msgKey}`)); };
      line.appendChild(delBtn);
    }
  });

  wrapper.appendChild(line);

  const tm = document.createElement("div");
  tm.className = "time";
  tm.textContent = new Date(d.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  wrapper.appendChild(tm);

  chat.appendChild(wrapper);
  chat.scrollTop = chat.scrollHeight;
});
      
      // [ì‹¤ì‹œê°„ ì‚­ì œ ë°˜ì˜]
      onChildRemoved(chatRef, snap => {
        const removedMsg = document.getElementById(`wrapper-${snap.key}`);
        if (removedMsg) removedMsg.remove();
      });

    });
  });
}
</script>
</body>
</html>







