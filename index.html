<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Message with . . .</title>

<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">

<style>
body {
  font-family: 'SUIT', sans-serif;
  background: #ececec;
}

#enterScreen {
  max-width: 320px;
  margin: 80px auto;
  padding: 24px;
  background: white;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

#chatBox {
  max-width: 400px;
  margin: 20px auto;
  display: none;
}

#chat {
  background: #ecdff5;
  padding: 10px;
  height: 400px;
  overflow-y: auto;
  border-radius: 10px;
}

.bubble {
  max-width: 70%;
  padding: 8px 12px;
  margin: 6px 0;
  border-radius: 10px;
  font-size: 14px;
  clear: both;
}

.me {
  background: #664b7d;
  color: white;
  float: right;
  text-align: right;
}

.other {
  background: white;
  float: left;
}

.name {
  font-size: 12px;
  color: #444;
  margin: 2px 6px;
}

.time {
  font-size: 11px;
  opacity: 0.8;
  margin-top: 4px;
}

input {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  border-radius: 20px;
  border: none;
  outline: none;
}

button {
  width: 100%;
  padding: 10px;
  border-radius: 20px;
  border: none;
  background: #664b7d;
  color: white;
  cursor: pointer;
}

#inputArea {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

#inputArea input {
  flex: 1;
  width: auto;
}

#inputArea button {
  width: auto;
  padding: 10px;
  flex-shrink: 0;
}

.date-divider {
  text-align: center;
  font-size: 12px;
  color: #666;
  margin: 14px 0;
  position: relative;
}

.date-divider::before,
.date-divider::after {
  content: "";
  position: absolute;
  top: 50%;
  width: 30%;
  height: 1px;
  background: #ccc;
}

.date-divider::before {
  left: 0;
}

.date-divider::after {
  right: 0;
}

</style>
</head>

<body>

<!-- ÏûÖÏû• ÌôîÎ©¥ -->
<div id="enterScreen">
  <h3>Ï±ÑÌåÖ ÏûÖÏû•</h3>
  <input id="nickname" placeholder="ÎãâÎÑ§ÏûÑ">
  <input id="roomInput" placeholder="Î∞© Ïù¥Î¶Ñ">
  <button onclick="enterRoom()">ÏûÖÏû•ÌïòÍ∏∞</button>
</div>

<!-- Ï±ÑÌåÖ ÌôîÎ©¥ -->
<div id="chatBox">
  <h3 id="roomTitle"></h3>
  <div id="chat"></div>

  <div id="inputArea">
    <input id="msg" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•">
    <button onclick="send()">Ï†ÑÏÜ°</button>
  </div>
</div>

<script type="module">

/* 1Ô∏è‚É£ room ÌôïÏù∏ */
const params = new URLSearchParams(location.search);
const room = params.get("room");

/* 2Ô∏è‚É£ DOM */
const enterScreen = document.getElementById("enterScreen");
const chatBox = document.getElementById("chatBox");
const roomTitle = document.getElementById("roomTitle");
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");

let nickname = sessionStorage.getItem("nickname") || "";
let lastDate = "";

function formatDate(timestamp) {
  const d = new Date(timestamp);
  return `${d.getFullYear()}ÎÖÑ ${d.getMonth() + 1}Ïõî ${d.getDate()}Ïùº`;
}

/* 3Ô∏è‚É£ ÏûÖÏû• Î≤ÑÌäº */
window.enterRoom = () => {
  const nick = document.getElementById("nickname").value.trim();
  const roomName = document.getElementById("roomInput").value.trim();

  if (!nick || !roomName) {
    alert("ÎãâÎÑ§ÏûÑÍ≥º Î∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
    return;
  }

  // ‚≠ê ÎãâÎÑ§ÏûÑ Ï†ÄÏû•
  sessionStorage.setItem("nickname", nick);

  location.href = `?room=${encodeURIComponent(roomName)}`;
};

/* 4Ô∏è‚É£ room ÏûàÏùÑ ÎïåÎßå Firebase ÏãúÏûë */
if (room) {
  enterScreen.style.display = "none";
  chatBox.style.display = "block";
  roomTitle.textContent = `üí¨ ${room}`;
  nickname = sessionStorage.getItem("nickname");

  import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(({ initializeApp }) => {
    import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(({ getDatabase, ref, push, onChildAdded }) => {

      const app = initializeApp({
        apiKey: "AIzaSyBeMC5TQ7Jynxjpr_kjhijGUvZyly2D_gs",
        databaseURL: "https://my-chat-app-241e8-default-rtdb.firebaseio.com"
      });

      const db = getDatabase(app);
      const chatRef = ref(db, `chat/${room}`);

      window.send = () => {
        if (!msg.value.trim()) return;
        push(chatRef, {
          name: nickname,
          text: msg.value,
          time: Date.now()
        });
        msg.value = "";
      };

      msg.addEventListener("keydown", e => {
        if (e.key === "Enter") send();
      });

onChildAdded(chatRef, snap => {
  const d = snap.val();

  // üìÖ ÎÇ†Ïßú Íµ¨Î∂Ñ
  const currentDate = formatDate(d.time);
  if (currentDate !== lastDate) {
    const dateDiv = document.createElement("div");
    dateDiv.className = "date-divider";
    dateDiv.textContent = currentDate;
    chat.appendChild(dateDiv);
    lastDate = currentDate;
  }

  // ‚≠ê ÏÉÅÎåÄÎ∞© ÎãâÎÑ§ÏûÑ (ÎßêÌíçÏÑ† Î∞ñ)
  if (d.name !== nickname) {
    const nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.textContent = d.name;
    chat.appendChild(nameDiv);
  }

  // üí¨ ÎßêÌíçÏÑ†
  const b = document.createElement("div");
  b.className = "bubble " + (d.name === nickname ? "me" : "other");

  const textDiv = document.createElement("div");
  textDiv.textContent = d.text;
  b.appendChild(textDiv);

  const timeDiv = document.createElement("div");
  timeDiv.className = "time";
  timeDiv.textContent = new Date(d.time).toLocaleTimeString();
  b.appendChild(timeDiv);

  chat.appendChild(b);
  chat.scrollTop = chat.scrollHeight;
});
        b.innerHTML += `<div>${d.text}</div><div class="time">${new Date(d.time).toLocaleTimeString()}</div>`;
        chat.appendChild(b);
        chat.scrollTop = chat.scrollHeight;
      });

    });
  });
}
</script>

</body>

</html>





